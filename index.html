<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelFlex | Ultimate Multi-Format Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Progress Bar Styles */
        #topProgressBarContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(226, 232, 240, 0.5);
            z-index: 1000;
            display: none;
        }
        #topProgressBar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #2563eb, #7c3aed, #2563eb);
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
            transition: width 0.4s cubic-bezier(0.1, 0.7, 1.0, 0.1);
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .custom-loader { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        #bottomBatchBar { transform: translateY(100%); transition: transform 0.3s ease-out; box-shadow: 0 -10px 25px -5px rgba(0, 0, 0, 0.3); }
        #bottomBatchBar.show { transform: translateY(0); }
        .format-btn { font-size: 9px; font-weight: 800; padding: 6px 4px; border-radius: 4px; transition: all 0.2s; border: 1px solid #e2e8f0; text-align: center; background: white; }
        .format-btn:hover { background-color: #2563eb; color: white; border-color: #2563eb; transform: translateY(-1px); }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 pb-40">

    <div id="topProgressBarContainer">
        <div id="topProgressBar"></div>
    </div>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Ahsan's <span class="text-blue-600">Converter Pro</span></h1>
                <p class="text-slate-500 text-sm">Convert to JPEG, PNG, WEBP, GIF, SVG & PDF</p>
            </div>
            <div id="stats" class="text-right text-xs font-mono text-slate-400">
                FILES: <span id="fileCount">0</span>/100
            </div>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-6 flex flex-wrap gap-6 items-end">
            <div class="flex-1 min-w-[250px]">
                <label class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Global Quality (Updates all previews)</label>
                <div class="flex items-center gap-4">
                    <input type="range" id="globalQuality" min="5" max="100" value="80" class="flex-1 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <span id="globalQualityVal" class="text-sm font-bold text-blue-600 w-10">80%</span>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Grid View</label>
                <select id="itemsPerRow" class="bg-slate-50 border border-slate-200 rounded-lg py-2 px-4 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="grid-cols-1">1</option>
                    <option value="grid-cols-2" selected>2</option>
                    <option value="grid-cols-3">3</option>
                    <option value="grid-cols-4">4</option>
                </select>
            </div>
            <button id="convertAllBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-8 rounded-lg transition-all shadow-lg shadow-blue-200 active:scale-95">
                Process All
            </button>
        </div>

        <div id="dropZone" class="group border-2 border-dashed border-slate-300 rounded-2xl p-12 text-center hover:bg-blue-50/50 hover:border-blue-400 transition-all cursor-pointer mb-8">
            <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-50 text-blue-600 rounded-full mb-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </div>
            <h3 class="text-lg font-semibold text-slate-700">Drop Images Here</h3>
            <p class="text-slate-400 text-sm mt-1">Files are processed 100% locally in your browser</p>
        </div>

        <div id="gallery" class="grid gap-6 grid-cols-2"></div>
    </div>

    <div id="bottomBatchBar" class="fixed bottom-0 left-0 right-0 bg-slate-900 text-white p-5 z-50 flex flex-col md:flex-row items-center justify-center gap-6">
        <div class="flex items-center gap-4">
            <span class="text-sm font-medium text-slate-400">Batch Download As:</span>
            <select id="batchFormat" class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                <option value="webp">WEBP (Smallest)</option>
                <option value="jpeg">JPEG (Standard)</option>
                <option value="png">PNG (High Quality)</option>
                <option value="pdf">PDF (Document)</option>
                <option value="gif">GIF</option>
                <option value="svg">SVG</option>
            </select>
        </div>
        <div class="flex gap-3">
            <button onclick="downloadAll()" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-2.5 rounded-lg font-bold shadow-xl transition-all">
                Download All Files
            </button>
            <button onclick="location.reload()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2.5 rounded-lg text-sm transition-all">
                Clear
            </button>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const gallery = document.getElementById('gallery');
        const globalQuality = document.getElementById('globalQuality');
        const globalQualityVal = document.getElementById('globalQualityVal');
        const convertAllBtn = document.getElementById('convertAllBtn');
        const bottomBatchBar = document.getElementById('bottomBatchBar');
        const topBarContainer = document.getElementById('topProgressBarContainer');
        const topBar = document.getElementById('topProgressBar');

        let uploadedFiles = [];

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        globalQuality.oninput = (e) => {
            globalQualityVal.textContent = `${e.target.value}%`;
        };

        document.getElementById('itemsPerRow').onchange = (e) => {
            gallery.className = `grid gap-6 ${e.target.value}`;
        };

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);

        async function handleFiles(files) {
            const list = Array.from(files);
            for (const file of list) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileObj = {
                        id: Math.random().toString(36).substr(2, 9),
                        src: e.target.result,
                        name: file.name,
                        originalSize: file.size,
                        newSize: null,
                        quality: 80,
                        processed: false,
                        blobs: {}
                    };
                    uploadedFiles.push(fileObj);
                    renderGallery();
                };
                reader.readAsDataURL(file);
            }
        }

        async function processSingleImage(id, qualityValue) {
            const file = uploadedFiles.find(f => f.id === id);
            file.quality = qualityValue;
            
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    canvas.toBlob((blob) => {
                        if (file.blobs['webp']) URL.revokeObjectURL(file.blobs['webp']);
                        file.blobs['webp'] = URL.createObjectURL(blob);
                        file.newSize = blob.size;
                        file.processed = true;
                        updateCardUI(id);
                        resolve();
                    }, 'image/webp', qualityValue / 100);
                };
                img.src = file.src;
            });
        }

        function updateCardUI(id) {
            const file = uploadedFiles.find(f => f.id === id);
            const sizeDisplay = document.getElementById(`size-${id}`);
            const qDisplay = document.getElementById(`qval-${id}`);
            if (sizeDisplay) sizeDisplay.innerHTML = `<span class="text-blue-600 font-bold">${formatBytes(file.newSize)}</span> <span class="text-slate-400 text-[9px] line-through">${formatBytes(file.originalSize)}</span>`;
            if (qDisplay) qDisplay.textContent = `${file.quality}%`;
        }

        function renderGallery() {
            gallery.innerHTML = '';
            document.getElementById('fileCount').textContent = uploadedFiles.length;
            
            uploadedFiles.forEach(file => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-xl border border-slate-200 shadow-sm transition-all hover:border-blue-200`;
                card.innerHTML = `
                    <div class="relative aspect-video mb-3 rounded-lg overflow-hidden bg-slate-100 border border-slate-100">
                        <img src="${file.src}" class="w-full h-full object-cover">
                        <div id="size-${file.id}" class="absolute bottom-2 left-2 bg-white/95 px-2 py-1 rounded text-[10px] font-mono shadow-sm">
                            ${file.processed ? `<span class="text-blue-600 font-bold">${formatBytes(file.newSize)}</span>` : formatBytes(file.originalSize)}
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Quality Control</label>
                                <span id="qval-${file.id}" class="text-[10px] font-bold text-blue-600 bg-blue-50 px-1.5 rounded">${file.quality}%</span>
                            </div>
                            <input type="range" min="5" max="100" value="${file.quality}" 
                                onchange="processSingleImage('${file.id}', this.value)"
                                oninput="document.getElementById('qval-${file.id}').textContent = this.value + '%'"
                                class="w-full h-1 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>

                        <div class="grid grid-cols-3 gap-1.5">
                            <button onclick="downloadFile('${file.id}', 'webp')" class="format-btn hover:bg-blue-500">WEBP</button>
                            <button onclick="downloadFile('${file.id}', 'jpeg')" class="format-btn hover:bg-orange-500">JPEG</button>
                            <button onclick="downloadFile('${file.id}', 'png')" class="format-btn hover:bg-green-600">PNG</button>
                            <button onclick="downloadFile('${file.id}', 'pdf')" class="format-btn hover:bg-red-600">PDF</button>
                            <button onclick="downloadFile('${file.id}', 'svg')" class="format-btn hover:bg-purple-600">SVG</button>
                            <button onclick="downloadFile('${file.id}', 'gif')" class="format-btn hover:bg-pink-600">GIF</button>
                        </div>
                    </div>
                `;
                gallery.appendChild(card);
            });
        }

        convertAllBtn.onclick = async () => {
            if (uploadedFiles.length === 0) return;

            const q = parseInt(globalQuality.value);
            topBarContainer.style.display = 'block';
            topBar.style.width = '0%';

            for (let i = 0; i < uploadedFiles.length; i++) {
                await processSingleImage(uploadedFiles[i].id, q);
                let progress = ((i + 1) / uploadedFiles.length) * 100;
                topBar.style.width = progress + '%';
            }
            
            setTimeout(() => {
                topBarContainer.style.display = 'none';
                bottomBatchBar.classList.add('show');
            }, 600);
        };

        window.downloadFile = (id, format) => {
            const file = uploadedFiles.find(f => f.id === id);
            const name = file.name.split('.')[0];
            const q = file.quality / 100;

            const img = new Image();
            img.src = file.src;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF(img.width > img.height ? 'l' : 'p', 'px', [img.width, img.height]);
                    pdf.addImage(canvas.toDataURL('image/jpeg', q), 'JPEG', 0, 0, img.width, img.height);
                    pdf.save(`${name}.pdf`);
                } else if (format === 'svg') {
                    const svgTag = `<svg xmlns="http://www.w3.org/2000/svg" width="${img.width}" height="${img.height}"><image href="${file.src}" width="100%" height="100%"/></svg>`;
                    const blob = new Blob([svgTag], {type: 'image/svg+xml'});
                    const url = URL.createObjectURL(blob);
                    triggerDownload(url, `${name}.svg`);
                } else if (format === 'png') {
                    triggerDownload(canvas.toDataURL('image/png'), `${name}.png`);
                } else if (format === 'gif') {
                    triggerDownload(canvas.toDataURL('image/gif'), `${name}.gif`);
                } else if (format === 'jpeg') {
                    triggerDownload(canvas.toDataURL('image/jpeg', q), `${name}.jpg`);
                } else {
                    triggerDownload(canvas.toDataURL('image/webp', q), `${name}.webp`);
                }
            };
        };

        function triggerDownload(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

        function downloadAll() {
            const format = document.getElementById('batchFormat').value;
            uploadedFiles.forEach((file, i) => {
                setTimeout(() => downloadFile(file.id, format), i * 350);
            });
        }
    </script>
</body>
</html>
